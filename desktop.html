<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Desktop</title>
<link rel="stylesheet" href="98.css">
<link rel="icon" type="image/png" href="meos.png">
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<style>
    body { background: #c3c3c3; font-family: Tahoma, sans-serif; margin:0; padding:0; height:100vh; overflow:hidden; }
    .taskbar { position: fixed; bottom:0; left:0; width:100%; height:30px; background:#808080; display:flex; align-items:center; padding:2px; box-sizing:border-box; }
    .start-button { background:#c0c0c0; border:2px outset #fff; padding:2px 10px; cursor:pointer; font-size:14px; margin-right:5px; user-select:none; }
    .start-menu { position:absolute; bottom:30px; left:2px; width:240px; background:#c0c0c0; border:2px outset #fff; display:none; flex-direction:column; box-sizing:border-box; z-index:1500; }
    .start-menu div { padding:6px 8px; cursor:pointer; user-select:none; }
    .start-menu div:hover { background:#000; color:white; }

    .window { width:420px; border:2px solid black; background:#fff; position:absolute; top:80px; left:80px; box-shadow:2px 2px #000; display:none; min-height:120px; box-sizing:border-box; }
    .title-bar { background:black; color:white; padding:6px; display:flex; justify-content:space-between; align-items:center; cursor:move; user-select:none; }
    .title-bar button { margin-left:8px; background:#c0c0c0; border:2px outset #fff; cursor:pointer; font-weight:bold; }
    .menu-bar { background:#c0c0c0; padding:2px 6px; font-size:13px; display:flex; gap:12px; border-bottom:2px solid #808080; cursor:default; }
    .menu-bar span { padding:2px 4px; } .menu-bar span:hover { background:#000; color:#fff; }
    .content { padding:10px; box-sizing:border-box; }

    .icons { display:flex; flex-wrap:wrap; gap:10px; }
    .icon { width:60px; text-align:center; cursor:pointer; }
    .icon img { width:32px; height:32px; }

    .context-menu { position:absolute; background:#c0c0c0; border:2px outset #fff; display:none; flex-direction:column; z-index:2000; min-width:160px; box-sizing:border-box; user-select:none; }
    .context-menu div { padding:7px 10px; cursor:pointer; white-space:nowrap; } .context-menu div:hover { background:#000; color:#fff; }

    /* Terminal */
    .terminal { background:#000; color:#00ff00; font-family:monospace; padding:6px; box-sizing:border-box; height:220px; overflow-y:auto; position:relative; transition: background 0.3s, color 0.3s; }
    .terminal.alert { background:#600; color:#ffb3b3; }
    .terminal.shake { animation: shake 0.6s; }
    @keyframes shake { 0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)} }
    .terminal .ascii-overlay { position:absolute; inset:6px; display:flex; align-items:center; justify-content:center; pointer-events:none; color:#fff; font-family:monospace; font-size:12px; white-space:pre; text-align:center; opacity:0; transition:opacity 0.2s; z-index:50; }
    .terminal.infected .ascii-overlay { opacity:1; }
    .terminal pre { margin:0; white-space:pre-wrap; }
    .terminal input { background:transparent; color:inherit; border:none; outline:none; font-family:monospace; width:60%; }

    textarea { width:100%; height:200px; font-family:monospace; box-sizing:border-box; }

    /* small responsive */
    @media (max-width:600px){ .window{ width:90%; left:5%; } }
  
.window .content iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}
.window.maximized .content {
  height: calc(100% - 30px); /* fill below title bar */
}

.task-tabs { margin-bottom: 8px; }
.task-tabs button { margin-right: 4px; font-size: 13px; padding: 2px 6px; }
#task-list li, #task-tasks li { cursor: pointer; padding: 2px 4px; }
#task-list li.selected, #task-tasks li.selected { background: #000; color: #fff; }

#task-list li.selected, #task-tasks li.selected {
  background: #000;
  color: #fff;
}

.submenu { position: relative; padding:6px 8px; cursor:pointer; }
.submenu-items {
  display: none;
  position: absolute;
  left: 100%;
  top: 0;
  background: #c0c0c0;
  border: 2px outset #fff;
  min-width: 160px;
  z-index: 1600;
}
.submenu:hover .submenu-items { display: block; }
.submenu div:hover { background:#000; color:#fff; }

.menu-icon {
  width: 16px;
  height: 16px;
  margin-right: 6px;
  vertical-align: middle;
}
.start-menu div { display:flex; align-items:center; }
.submenu { position: relative; padding:6px 8px; cursor:pointer; }
.submenu-items div { display:flex; align-items:center; padding:4px 6px; }
.submenu-items img { margin-right:6px; }

.start-menu {
  position: absolute;
  top: 28px;
  left: 2px;
  width: 220px;
  background: #c0c0c0;
  border: 2px outset #fff;
  display: none;
  flex-direction: column;
  z-index: 2500;
}
.submenu { position: relative; padding:6px 8px; cursor:pointer; display:flex; align-items:center; }
.submenu-items { display:none; position:absolute; left:100%; top:0; background:#c0c0c0; border:2px outset #fff; min-width:160px; z-index:2600; flex-direction:column; }
.submenu:hover .submenu-items { display:flex; }
.start-menu div:hover { background:#000; color:#fff; }

:root {
  --menu-bg: #c0c0c0;
  --menu-text: #000000;
  --window-bg: #ffffff;
  --window-border: #000000;
}
body {
  background-color: var(--window-bg);
  color: var(--menu-text);
}
.start-menu, .submenu-items {
  background: var(--menu-bg) !important;
  color: var(--menu-text) !important;
}
.start-menu div, .submenu-items div {
  color: var(--menu-text) !important;
}
.window {
  background: var(--window-bg) !important;
  border: 2px solid var(--window-border) !important;
  color: var(--menu-text) !important;
}
.taskbar {
  background: var(--menu-bg) !important;
  color: var(--menu-text) !important;
}


.start-menu div, .submenu-items div {
  color: #000000 !important;
}
.start-menu div:hover, .submenu-items div:hover {
  background: #b3b3b3 !important;
  color: #000000 !important; /* yellow like Win95 style hover */
}


#startup-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: black;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

#startup-screen img {
  max-width: 60%;
  margin: 12px 0;
}

.startup-logo {
  max-width: 300px;
}

.win95-btn {
  background:#c0c0c0;
  border:2px outset #fff;
  padding:2px 8px;
  cursor:pointer;
  font-size:12px;
  user-select:none;
}
.win95-btn:active {
  border:2px inset #000;
}
#media-slider {
  -webkit-appearance:none;
  height:10px;
  background:#808080;
  border:2px inset #fff;
}
#media-slider::-webkit-slider-thumb {
  -webkit-appearance:none;
  width:12px;
  height:16px;
  background:#c0c0c0;
  border:2px outset #fff;
  cursor:pointer;
}
#media-slider::-moz-range-thumb {
  width:12px;
  height:16px;
  background:#c0c0c0;
  border:2px outset #fff;
  cursor:pointer;
}


.ms-cell {
  width:24px;
  height:24px;
  background:#c0c0c0;
  border:2px outset #fff;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:monospace;
  font-weight:bold;
  cursor:pointer;
  user-select:none;
}
.ms-cell.revealed {
  background:#dcdcdc;
  border:1px solid #808080;
}
.ms-cell.flag { color:red; }
.ms-cell.mine { background:#f00; }
.ms-row { display:flex; }


#walker-overlay {
  position: absolute;
  bottom: 10px;
  left: 10px;
  width: 80px;
  height: 120px;
  background: url("walker.gif") no-repeat center/contain;
  display: none;
  pointer-events: none;
  z-index: 100;
}


/* Classic MEOS style cursor from PNG */
body, .window, .start-button, .win95-btn, .menu-bar, .submenu, .icon, .ms-cell {
  cursor: url('arrow.png') 0 0, auto;
}

/* Keep text inputs and editable fields with the normal text caret */
input[type="text"],
input[type="password"],
textarea,
input[type="search"],
[contenteditable="true"] {
  cursor: text !important;
}
</style>
</head>
<body><div id="startup-screen"><img alt="MEOS Logo" class="startup-logo" src="meos.png"/><img alt="Startup MEOS" class="startup-anim" src="loading.gif"/></div>
<!-- Notepad -->
<div class="window" id="notepad" style="top:140px; left:80px; display:block;">
<div class="title-bar"><span>Notepad</span><div><button onclick="minimizeApp('notepad')">_</button><button onclick="maximizeApp('notepad')">‚ñ°</button><button onclick="closeApp('notepad')">X</button></div></div>

<div class="content">
  <textarea placeholder="Type here..."></textarea>
  <div style="margin-top:6px; text-align:right;">
    <button class="win95-btn" onclick="saveNotepad()">üíæ Save As</button>
    <button class="win95-btn" onclick="saveNotepadAsMef()">üíæ Save As .MEF</button>
    <button class="win95-btn" onclick="saveAndOpenMef()">‚ñ∂ Save & Open in MEF Viewer</button>
  </div>
</div>

</div>

<!-- Millennium Edition File Viewer/Editor -->
<div class="window" id="mef-viewer" style="top:240px; left:240px; width:640px; height:480px; display:none;">
  <div class="title-bar">
    <span>Millennium Edition File</span>
    <div>
      <button onclick="minimizeApp('mef-viewer')">_</button>
      <button onclick="maximizeApp('mef-viewer')">‚ñ°</button>
      <button onclick="closeApp('mef-viewer')">X</button>
    </div>
  </div>
  <div class="menu-bar">
    <span onclick="downloadMef()">üíæ Save As</span>
    <span onclick="editMef()">‚úè Edit</span>
    <span onclick="viewMef()">üëÅ View</span>
    <span onclick="document.getElementById('mef-upload').click()">üì§ Upload</span>
    <span onclick="openApp('help')">‚ùì Help</span>
  </div>
  <div class="content" style="height:calc(100% - 30px);">
    <input id="mef-upload" type="file" accept=".mef,.txt,.html" style="display:none;" />

    <iframe id="mef-frame" src="about:blank" style="width:100%; height:100%; border:none;"></iframe>
    <textarea id="mef-editor" style="display:none; width:100%; height:100%; font-family:monospace; font-size:13px;"></textarea>
  </div>
</div>
<!-- Write -->
<div class="window" id="write" style="top:200px; left:140px;">
<div class="title-bar"><span>Write</span><div><button onclick="minimizeApp('write')">_</button><button onclick="maximizeApp('write')">‚ñ°</button><button onclick="closeApp('write')">X</button></div></div>
<div class="content">
  <textarea placeholder="Write your document here..."></textarea>
  <div style="margin-top:6px; text-align:right;">
    <button class="win95-btn" onclick="saveWrite()">üíæ Save As</button>
  </div>
</div>
</div>
<!-- Paint -->
<div class="window" id="paint" style="top:170px; left:200px;">
<div class="title-bar"><span>Paint</span><div><button onclick="minimizeApp('paint')">_</button><button onclick="maximizeApp('paint')">‚ñ°</button><button onclick="closeApp('paint')">X</button></div></div>
<div class="content">
<iframe src="https://jspaint.app/" title="Paint"></iframe>
</div>
</div>
<!-- Calculator -->
<div class="window" id="calculator" style="top:240px; left:180px;">
<div class="title-bar"><span>Calculator</span>
<div>
<button onclick="minimizeApp('calculator')">_</button>
<button onclick="maximizeApp('calculator')">‚ñ°</button>
<button onclick="closeApp('calculator')">X</button>
</div>
</div>
<div class="content" style="background:#c0c0c0; padding:10px; font-family:monospace; display:flex; flex-direction:column; align-items:center;">
<input id="calc-display" readonly="" style="width:90%; margin-bottom:8px; text-align:right; font-size:16px; padding:4px; border:2px inset #fff; background:#fff;" type="text"/>
<div style="display:grid; grid-template-columns:repeat(4,50px); gap:4px;">
<button class="win95-btn" onclick="calcInput('7')">7</button>
<button class="win95-btn" onclick="calcInput('8')">8</button>
<button class="win95-btn" onclick="calcInput('9')">9</button>
<button class="win95-btn" onclick="calcInput('/')">/</button>
<button class="win95-btn" onclick="calcInput('4')">4</button>
<button class="win95-btn" onclick="calcInput('5')">5</button>
<button class="win95-btn" onclick="calcInput('6')">6</button>
<button class="win95-btn" onclick="calcInput('*')">*</button>
<button class="win95-btn" onclick="calcInput('1')">1</button>
<button class="win95-btn" onclick="calcInput('2')">2</button>
<button class="win95-btn" onclick="calcInput('3')">3</button>
<button class="win95-btn" onclick="calcInput('-')">-</button>
<button class="win95-btn" onclick="calcInput('0')">0</button>
<button class="win95-btn" onclick="calcInput('.')">.</button>
<button class="win95-btn" onclick="calcEquals()">=</button>
<button class="win95-btn" onclick="calcInput('+')">+</button>
<button class="win95-btn" onclick="calcClear()" style="grid-column:span 4;">C</button>
</div>
</div>
</div>
<!-- LucasScape -->
<div class="window" id="lucasscape" style="top:270px; left:220px;">
<div class="title-bar">
<span>The LucasScape</span>
<div><button onclick="minimizeApp('lucasscape')">_</button><button onclick="maximizeApp('lucasscape')">‚ñ°</button><button onclick="closeApp('lucasscape')">X</button></div>
</div>
<div class="content">
<iframe src="lucasscape.html" title="The LucasScape"></iframe>
</div>
</div>
<!-- Media Player -->
<div class="window" id="media-player" style="top:300px; left:250px; width:420px; height:320px; display:none;">
<div class="title-bar">
<span>Media Player</span>
<div>
<button onclick="minimizeApp('media-player')">_</button>
<button onclick="maximizeApp('media-player')">‚ñ°</button>
<button onclick="closeApp('media-player')">X</button>
</div>
</div>
<!-- NEW menu bar -->
<div class="menu-bar">
<span onclick="document.getElementById('media-file').click()">File</span>
<span>Device</span>
<span onclick="alert('Media Player v1.0 - MEOS')">Help</span>
</div>
<div class="content" style="padding:10px; font-size:13px; background:#c0c0c0; display:flex; flex-direction:column; align-items:center;">
<input accept="audio/*,video/*" id="media-file" style="margin-bottom:8px; font-size:12px; display:none;" type="file"/>
<video height="200" id="media-element" style="background:#000; display:none;" width="360"></video>
<audio id="media-audio" style="display:none;"></audio>
<div style="margin-top:8px; display:flex; gap:4px;">
<button class="win95-btn" onclick="playMedia()">‚ñ∂ Play</button>
<button class="win95-btn" onclick="pauseMedia()">‚ùö‚ùö Pause</button>
<button class="win95-btn" onclick="stopMedia()">‚ñ† Stop</button>
</div>
<input id="media-slider" max="100" min="0" style="width:90%; margin-top:10px;" type="range" value="0">
</input></div>
</div>
<!-- Quake -->
<div class="window" id="quake" style="top:330px; left:280px;">
<div class="title-bar">
<span>Quake</span>
<div><button onclick="minimizeApp('quake')">_</button><button onclick="maximizeApp('quake')">‚ñ°</button><button onclick="closeApp('quake')">X</button></div>
</div>
<div class="content">
<iframe src="https://www.netquake.io/" title="Quake"></iframe>
</div>
</div>
<!-- Control Panel -->
<div class="window" id="controlpanel" style="top:360px; left:320px;">
<div class="title-bar"><span>Control Panel</span><div><button onclick="minimizeApp('controlpanel')">_</button><button onclick="maximizeApp('controlpanel')">‚ñ°</button><button onclick="closeApp('controlpanel')">X</button></div></div>
<div class="content">
<div class="cp-tabs">
<button onclick="showCpTab('color')">Color</button>
<button onclick="showCpTab('fonts')">Fonts</button>
<button onclick="showCpTab('mouse')">Mouse</button>
<button onclick="showCpTab('desktop')">Desktop</button>
<button onclick="showCpTab('keyboard')">Keyboard</button>
<button onclick="showCpTab('intl')">International</button>
<button onclick="showCpTab('datetime')">Date/Time</button>
<button onclick="showCpTab('system')">System &amp; Sound</button>
</div>
<!-- Color -->
<div class="cp-tab" id="cp-color">
<h4>Color Scheme</h4>
<select id="color-scheme">
<option>Default</option>
<option>High Contrast</option>
<option>Ocean</option>
</select>
<button onclick="applyColorScheme()">Apply</button>
</div>
<!-- Fonts -->
<div class="cp-tab" id="cp-fonts" style="display:none;">
<h4>Fonts</h4>
<select>
<option>Tahoma</option>
<option>Arial</option>
<option>Courier New</option>
<option>Verdana</option>
<option>Georgia</option>
<option>Times New Roman</option>
<option>Comic Sans MS</option>
<option>Lucida Console</option>
<option>Trebuchet MS</option>
</select>
<button onclick="applyFonts()">Apply</button>
</div>

<!-- Mouse -->
<div class="cp-tab" id="cp-mouse" style="display:none;">
  <h4>Mouse Settings</h4>
  <label>Pointer Speed: <input type="range"/></label><br/>
  <label>Double-click Speed: <input type="range"/></label><br/>
  <label><input type="checkbox"/> Enable Pointer Trails</label><br/><br/>
  
  <label>Custom Cursor: <input type="file" id="cursor-upload" accept=".png,.ico"></label><br/><br/>
  <button onclick="applyCustomCursor()">Apply</button>
  <button onclick="resetCursor()">Reset</button>
</div>

<!-- Desktop -->
<div class="cp-tab" id="cp-desktop" style="display:none;">
<h4>Desktop</h4>
<label>Wallpaper: <input type="file"/></label><br/>
<label>Screensaver: <input type="file"/></label><br/>
<button onclick="alert('Desktop updated!')">Apply</button>
</div>
<!-- Keyboard -->
<div class="cp-tab" id="cp-keyboard" style="display:none;">
<h4>Keyboard</h4>
<label>Cursor Blink Rate: <input type="range"/></label><br/>
<label>Repeat Delay: <input type="range"/></label><br/>
<label>Repeat Rate: <input type="range"/></label><br/>
<button onclick="alert('Keyboard settings applied!')">Apply</button>
</div>
<!-- International -->
<div class="cp-tab" id="cp-intl" style="display:none;">
<h4>International</h4>
<label>Language: <input type="text" value="English (US)"/></label><br/>
<label>Country: <input type="text" value="United States"/></label><br/>
<label>Currency: <input type="text" value="$"/></label><br/>
<button onclick="alert('International settings applied!')">Apply</button>
</div>
<!-- Date/Time -->
<div class="cp-tab" id="cp-datetime" style="display:none; text-align:center;">
<h4>Date &amp; Time</h4>
<div id="cp-datetime-display" style="font-family:monospace; font-size:20px; margin:10px 0;"></div>
<div id="cp-datetime-date" style="font-family:monospace; font-size:16px; margin:6px 0;"></div>
<hr/>
<h4>Task Scheduler</h4>
<input id="task-time" type="time"/>
<input id="task-desc" placeholder="Task description" type="text"/>
<button onclick="addTask()">Add</button>
<ul id="task-list-datetime" style="text-align:left; margin-top:8px;"></ul>
<button onclick="alert('Date/Time applied!')">Apply</button>
</div>
<!-- System & Sound -->
<div class="cp-tab" id="cp-system" style="display:none;">
<h4>System &amp; Sound</h4>
<label>System Sound: <input type="file"/></label><br/>
<label>Custom Sound Scheme: <input type="file"/></label><br/>
<button onclick="alert('System sound applied!')">Apply</button>
</div>
</div>
</div>
<!-- Minesweeper -->
<div class="window" id="minesweeper" style="top:420px; left:380px;">
<div class="title-bar"><span>Minesweeper</span>
<div>
<button onclick="minimizeApp('minesweeper')">_</button>
<button onclick="maximizeApp('minesweeper')">‚ñ°</button>
<button onclick="closeApp('minesweeper')">X</button>
</div>
</div>
<div class="content" id="minesweeper-content" style="background:#c0c0c0; padding:6px; display:flex; flex-direction:column; align-items:center;">
<div style="display:flex; justify-content:space-between; align-items:center; width:200px; background:#808080; border:2px inset #fff; padding:2px; margin-bottom:6px;">
<div id="ms-counter" style="font-family:monospace; color:red; background:#000; padding:2px 6px;">010</div>
<div id="ms-face" style="cursor:pointer; font-size:18px;">üôÇ</div>
<div id="ms-timer" style="font-family:monospace; color:red; background:#000; padding:2px 6px;">000</div>
</div>
<div id="ms-grid"></div>
</div>
</div>
<!-- File Manager -->
<div class="window" id="file-manager" style="top:570px; left:540px;">
<div class="title-bar"><span>File Manager</span><div><button onclick="minimizeApp('file-manager')">_</button><button onclick="maximizeApp('file-manager')">‚ñ°</button><button onclick="closeApp('file-manager')">X</button></div></div>
<div class="content">
<iframe src="filemanager.html" title="File Manager"></iframe>
</div>
</div>
<!-- Hover -->
<div class="window" id="hover" style="top:500px; left:460px;">
<div class="title-bar"><span>Hover!</span><div><button onclick="minimizeApp('hover')">_</button><button onclick="maximizeApp('hover')">‚ñ°</button><button onclick="closeApp('hover')">X</button></div></div>
<div class="content">
<iframe src="https://web.archive.org/web/20131203172640if_/http://www.hover.ie/#single-player/play" title="Hover!"></iframe>
</div>
</div>
<!-- SkiFree -->
<div class="window" id="skifree" style="top:570px; left:540px;">
<div class="title-bar"><span>SkiFree</span><div><button onclick="minimizeApp('skifree')">_</button><button onclick="maximizeApp('skifree')">‚ñ°</button><button onclick="closeApp('skifree')">X</button></div></div>
<div class="content">
<iframe src="https://basicallydan.github.io/skifree.js/" title="SkiFree"></iframe>
</div>
</div>
<!-- Excel97 -->
<div class="window" id="excel97" style="top:330px; left:280px;">
<div class="title-bar">
<span>Excel 97</span>
<div class="window-buttons">
<button onclick="minimizeApp('excel97')">_</button>
<button onclick="maximizeApp('excel97')">‚ñ°</button>
<button onclick="closeApp('excel97')">X</button>
</div>
</div>
<div class="content">
<iframe src="https://rezmason.github.io/excel_97_egg/index.html" title="Excel 97"></iframe>
</div>
</div>
<!-- ME-DOS Prompt -->
<div class="window" id="me-dos" style="top:120px; left:120px; display:block;">
<div class="title-bar"><span>ME-DOS Prompt</span><div><button onclick="minimizeApp('me-dos')">_</button><button onclick="maximizeApp('me-dos')">‚ñ°</button><button onclick="closeApp('me-dos')">X</button></div></div>
<div class="menu-bar"><span>File</span><span>Edit</span><span>Properties</span><span>Help</span></div>
<div class="content terminal" id="dos-terminal">
<div class="ascii-overlay" id="ascii-overlay"></div>
<div id="walker-overlay"></div>
<pre id="dos-output">MagicME (R) MEOS
(C)Copyright MagicME 1995-1996, 1996-1997, 1997-2000, 2000-2001, 2025

C:\&gt;</pre>
<div><span id="dos-prompt">C:\&gt;</span><input autocomplete="off" id="dos-input" type="text"/></div>
</div>
</div>
<!-- System Monitor -->
<div class="window" id="sysmon" style="top:180px; left:180px; width:480px; height:320px; display:none;">
<div class="title-bar">
<span>System Monitor</span>
<div>
<button onclick="minimizeApp('sysmon')">_</button>
<button onclick="maximizeApp('sysmon')">‚ñ°</button>
<button onclick="closeApp('sysmon')">X</button>
</div>
</div>
<div class="content">
<p><strong>CPU Usage:</strong> <span id="sysmon-cpu">0%</span></p>
<p><strong>Memory Usage:</strong> <span id="sysmon-mem">0 MB / 4096 MB</span></p>
<p><strong>Processes:</strong> <span id="sysmon-proc">0</span></p>
<canvas height="160" id="sysmon-chart" style="border:1px solid #888; background:#000;" width="440"></canvas>
</div>
</div>
<!-- Vim -->
<div class="window" id="vim" style="top:220px; left:220px; width:720px; height:520px; display:none;">
<div class="title-bar">
<span>Vim</span>
<div>
<button onclick="minimizeApp('vim')">_</button>
<button onclick="maximizeApp('vim')">‚ñ°</button>
<button onclick="closeApp('vim')">X</button>
</div>
</div>
<div class="menu-bar">
<span onclick="document.getElementById('vim-help').style.display = (document.getElementById('vim-help').style.display==='block'?'none':'block')">Help</span>
<span onclick="document.getElementById('vim-vimrc').style.display = (document.getElementById('vim-vimrc').style.display==='block'?'none':'block')">.vimrc Example</span>
<span onclick="closeApp('vim')">Exit</span>
</div>
<div class="content" style="display:flex; flex-direction:column; height:calc(100% - 30px);">
<textarea id="vim-text" placeholder="-- VIM Simulation (type text here) --" style="flex:1; font-family:monospace; font-size:13px; background:#111; color:#0f0; padding:6px; border:none; outline:none;"></textarea>
<div id="vim-help" style="display:none; background:#111; color:#0f0; padding:8px; font-family:monospace; font-size:12px; overflow-y:auto; max-height:160px; border-top:2px solid #444;">
<pre>
Vim Command Reference

1. Insert Mode:
 i   - Insert before cursor
 a   - Insert after cursor
 I   - Insert at beginning of line
 A   - Insert at end of line
 o   - Open new line below
 O   - Open new line above
 Esc - Exit insert mode

2. Navigation:
 h / ‚Üê  - Left    l / ‚Üí - Right
 j / ‚Üì  - Down    k / ‚Üë - Up
 w - Next word    b - Prev word    e - End of word
 0 - Line start   $ - Line end
 gg - File start  G - File end
 NG - Go to line N (e.g., 5G)
</pre>
</div>
<div id="vim-vimrc" style="display:none; background:#222; color:#0f0; padding:8px; font-family:monospace; font-size:12px; overflow-y:auto; max-height:200px; border-top:2px solid #444;">
<pre>
" Example .vimrc snippet for plugin management with vim-plug
call plug#begin('~/.vim/plugged')

" Specify plugins here
Plug 'preservim/nerdtree' " File manager
Plug 'tpope/vim-surround' " Easily add/change/delete surroundings
Plug 'mattn/emmet-vim' " Emmet support for HTML/CSS
Plug 'leafgarland/typescript-vim' " TypeScript syntax highlighting
Plug 'pangloss/vim-javascript' " JavaScript syntax highlighting
Plug 'hail2u/vim-css3-syntax' " CSS3 syntax highlighting
Plug 'prettier/vim-prettier', { 'do': 'yarn install' } " Code formatter

call plug#end()

" Basic settings
set number        " Show line numbers
set autoindent    " Auto-indent lines
set tabstop=2     " Set tab width to 2 spaces
set shiftwidth=2  " Set shift width for autoindent to 2 spaces
set expandtab     " Use spaces instead of tabs
</pre>
</div>
</div>
</div>
<!-- Clock -->
<div class="window" id="clock" style="top:200px; left:480px; width:220px; height:220px; display:none;">
<div class="title-bar">
<span>Clock</span>
<div>
<button onclick="minimizeApp('clock')">_</button>
<button onclick="maximizeApp('clock')">‚ñ°</button>
<button onclick="closeApp('clock')">X</button>
</div>
</div>
<div class="menu-bar">
<span onclick="toggleClockMode()">View</span>
<span onclick="closeApp('clock')">Exit</span>
</div>
<div class="content" style="display:flex; justify-content:center; align-items:center; height:150px;">
<!-- Analog -->
<canvas height="150" id="clock-analog" style="display:block;" width="150"></canvas>
<!-- Digital -->
<div id="clock-digital" style="display:none; font-family:monospace; font-size:24px;"></div>
</div>
</div>
<!-- Context Menu -->
<div class="window" id="taskmanager" style="top:160px; left:160px; display:none;">
<div class="title-bar">
<span>Task Manager</span>
<div>
<button onclick="minimizeApp('taskmanager')">_</button>
<button onclick="maximizeApp('taskmanager')">‚ñ°</button>
<button onclick="closeApp('taskmanager')">X</button>
</div>
</div>
<div class="content">
<div class="task-tabs">
<button onclick="showTab('processes')">Processes</button>
<button onclick="showTab('tasks')">Tasks</button>
<button onclick="showTab('performance')">Performance</button>
<button onclick="showTab('scheduler')">Task Scheduler</button>
<button onclick="showTab('sysmon')">System Monitor</button>
</div>
<div class="task-tab" id="tab-processes">
<p><strong>Processes:</strong></p>
<ul id="task-list"></ul>
<div class="task-buttons">
<button onclick="endSelectedTask('task-list')">End Task</button>
<button onclick="switchSelectedTask('task-list')">Switch To</button>
</div>
</div>
<div class="task-tab" id="tab-tasks" style="display:none;">
<p><strong>Tasks:</strong></p>
<ul id="task-tasks"></ul>
<div class="task-buttons">
<button onclick="endSelectedTask('task-tasks')">End Task</button>
<button onclick="switchSelectedTask('task-tasks')">Switch To</button>
</div>
</div>
<div class="task-tab" id="tab-performance" style="display:none;">
<p><strong>CPU Usage:</strong> <span id="cpu-usage">0%</span></p>
<p><strong>Memory:</strong> <span id="mem-usage">OK</span></p>
</div>
<div class="task-tab" id="tab-sysmon" style="display:none;">
<p><strong>System Monitor Quick View:</strong></p>
<p>CPU: <span id="tm-sysmon-cpu">0%</span></p>
<p>Memory: <span id="tm-sysmon-mem">0 MB / 4096 MB</span></p>
<button onclick="openApp('sysmon')">Open Full Monitor</button>
</div>
<div class="task-tab" id="tab-scheduler" style="display:none;">
<p><strong>Task Scheduler</strong></p>
<p>(Placeholder for future tasks)</p>
</div>
</div>
</div>
<div class="window" id="themes" style="top:140px; left:160px; width:480px; height:360px; display:none;">
<div class="title-bar"><span>Desktop Themes</span><div><button onclick="minimizeApp('themes')">_</button><button onclick="maximizeApp('themes')">‚ñ°</button><button onclick="closeApp('themes')">X</button></div></div>
<div class="content">
<div class="theme-tabs">
<button onclick="showThemeTab('presets')">Themes</button>
<button onclick="showThemeTab('background')">Background</button>
<button onclick="showThemeTab('colors')">Colors</button>
<button onclick="showThemeTab('saved')">Saved</button>
</div>
<div class="theme-tab" id="tab-presets">
<select id="theme-list" size="10" style="width:100%;">
<option>Arizona</option><option>Black Leather Jacket</option><option>Blue and Red</option><option>Hot Dog Stand</option>
<option>Ocean</option><option>Pastel</option><option>The Blues</option><option>Tweed</option>
<option>Windows Default</option><option>Dangerous Creatures</option><option>Inside Your Computer</option><option>Leonardo da Vinci</option>
<option>Mystery</option><option>Nature</option><option>Science</option><option>Space</option>
<option>Sports</option><option>The 60's USA</option><option>The Golden Era</option><option>Travel</option>
<option>Windows 95</option><option>More Windows</option>
</select>
<div style="margin-top:8px;">
<button onclick="applyThemeFromList()">Apply</button>
<button onclick="saveCurrentTheme()">Save</button>
<button onclick="deleteSelectedSavedTheme()">Delete</button>
<button onclick="resetThemes()">Reset</button>
</div>
</div>
<div class="theme-tab" id="tab-background" style="display:none;">
<p>Upload image (PNG/JPG) or pick a color:</p>
<input accept=".png,.jpg,.jpeg" id="bg-upload" type="file"/><br/><br/>
<input id="bg-color" type="color" value="#c3c3c3"/>
<button onclick="applyBackground()">Apply</button>
<button onclick="clearBackground()">Clear</button>
</div>
<div class="theme-tab" id="tab-colors" style="display:none;">
<p>Menu background color:</p>
<input id="menu-color" type="color" value="#c0c0c0"/><br/><br/>
<p>Text color:</p>
<input id="text-color" type="color" value="#000000"/><br/><br/>
<button onclick="applyColors()">Apply</button>
</div>
<div class="theme-tab" id="tab-saved" style="display:none;">
<p>Saved Themes:</p>
<ul id="saved-themes-list"></ul>
<div style="margin-top:8px;">
<button onclick="exportSelectedTheme()">Export .met</button>
<input accept=".met" id="import-theme" type="file"/>
<button onclick="importTheme()">Import</button>
</div>
</div>
</div>
</div>
<div class="window" id="screensavers" style="top:160px; left:200px; width:420px; height:260px; display:none;">
<div class="title-bar"><span>Desktop Screensavers</span><div><button onclick="minimizeApp('screensavers')">_</button><button onclick="maximizeApp('screensavers')">‚ñ°</button><button onclick="closeApp('screensavers')">X</button></div></div>
<div class="content">
<p>Select a GIF screensaver or upload your own (.gif):</p>
<select id="screensaver-list" size="6" style="width:100%;">
<option>Matrix Rain</option><option>Floating Bubbles</option><option>Starfield</option><option>Slideshow</option>
</select>
<div style="margin-top:8px;">
<input accept=".gif" id="ss-upload" type="file"/><button onclick="applyScreensaver()">Apply</button>
<button onclick="clearScreensaver()">Clear</button>
</div>
<div id="screensaver-preview" style="margin-top:8px; height:120px; border:1px solid #888; display:flex; align-items:center; justify-content:center;"></div>
</div>
</div>
<!-- Help -->
<div class="window" id="help" style="top:200px; left:200px; width:300px; height:160px; display:none;">
<div class="title-bar">
<span>Help</span>
<div>
<button onclick="minimizeApp('help')">_</button>
<button onclick="maximizeApp('help')">‚ñ°</button>
<button onclick="closeApp('help')">X</button>
</div>
</div>
<div class="content">
<h3>MagicME Operating System (MEOS)</h3>
<p><strong>Version:</strong> v1.0</p>
<p><strong>¬© MagicME 1995-1996, 1996-1997, 1997-2000, 2000-2001, 2025</strong></p>
<hr/>
<h4>Applications</h4>
<ul>
<li>Notepad ‚Äî Version v1.0 (working)</li>
<li>Write ‚Äî Version v1.0 (working)</li>
<li>Paint ‚Äî Version v1.0 (working)</li>
<li>Calculator ‚Äî Version v1.0 (working)</li>
<li>The LucasScape ‚Äî Version v1.0 (working)</li>
<li>Media Player ‚Äî Version v1.0 (working)</li>
<li>Quake ‚Äî Version v1.0 (working)</li>
<li>Control Panel ‚Äî Version v1.0 (working)</li>
<li>ME-DOS Prompt ‚Äî Version v1.0 (working)</li>
<li>Minesweeper ‚Äî Version v1.0 (working)</li>
<li>File Manager ‚Äî Version v1.0 (working)</li>
<li>Hover! ‚Äî Version v1.0 (working)</li>
<li>SkiFree ‚Äî Version v1.0 (working)</li>
<li>Excel 97 ‚Äî Version v1.0 (working)</li>
<li>Vim ‚Äî Version v1.0 (working)</li>
<li>Task Manager ‚Äî Version v1.0 (working)</li>
<li>System Monitor ‚Äî Version v1.0 (working)</li>
<li>Desktop Themes ‚Äî Version v1.0 (working)</li>
<li>Desktop Screensavers ‚Äî Version v1.0 (working)</li>
<li>Clock ‚Äî Version v1.0 (working)</li>
<li>Run ‚Äî Version v1.0 (working)</li>
<li>Find ‚Äî Version v1.0 (working)</li>
</ul>
</div>
</div>
<!-- Run -->
<div class="window" id="run" style="top:200px; left:200px; width:300px; height:160px; display:none;">
<div class="title-bar">
<span>Run</span>
<div>
<button onclick="minimizeApp('run')">_</button>
<button onclick="maximizeApp('run')">‚ñ°</button>
<button onclick="closeApp('run')">X</button>
</div>
</div>
<div class="content" style="padding:10px; font-size:13px;">
<p>Type the name of a program, folder, document, or Internet resource:</p>
<input id="run-input" oninput="updateRunSuggestions()" style="width:95%; margin-bottom:4px;" type="text"/>
<ul id="run-suggestions" style="list-style:none; margin:0; padding:0; max-height:70px; overflow-y:auto; border:1px inset #999; background:#fff; font-size:12px; display:none;"></ul>
<div style="text-align:right; margin-top:6px;">
<button class="win95-btn" onclick="executeRun()">OK</button>
<button class="win95-btn" onclick="closeApp('run')">Cancel</button>
</div>
</div>
</div>
<!-- Find -->
<div class="window" id="find" style="top:220px; left:240px; width:380px; height:200px; display:none;">
<div class="title-bar">
<span>Find: Files or Folders</span>
<div>
<button onclick="minimizeApp('find')">_</button>
<button onclick="maximizeApp('find')">‚ñ°</button>
<button onclick="closeApp('find')">X</button>
</div>
</div>
<div class="content" style="padding:10px; font-size:13px;">
<label>Search for files or folders named:</label><br/>
<input id="find-input" style="width:95%; margin:6px 0;" type="text"/>
<div style="text-align:right;">
<button class="win95-btn" onclick="executeFind()">Find Now</button>
<button class="win95-btn" onclick="closeApp('find')">Cancel</button>
</div>
<ul id="find-results" style="margin-top:10px; max-height:80px; overflow-y:auto; font-family:monospace;"></ul>
</div>
</div>
<div aria-hidden="true" class="context-menu" id="context-menu" role="menu">
<div id="ctx-refresh">Refresh</div>
<div id="ctx-cut">Cut</div>
<div id="ctx-copy">Copy</div>
<div id="ctx-paste">Paste</div>
<div id="ctx-open-control">Open Control Panel</div>
<div id="ctx-open-task">Open Task Manager</div></div>
<!-- Taskbar -->
<div class="taskbar" style="position:fixed; top:0; left:0; width:100%; height:28px; background:#c0c0c0; border-bottom:2px outset #fff; display:flex; align-items:center; padding:2px 6px; box-sizing:border-box; z-index:2000;">
<div class="start-button" onclick="toggleStartMenu()">Start</div>
<div class="start-menu" id="start-menu">
<div class="submenu">
<img class="menu-icon" src="#"/> Programs
      <div class="submenu-items">
<div class="submenu">All Apps
          <div class="submenu-items">
<div onclick="openApp('notepad')">Notepad</div>
<div onclick="openApp('write')">Write</div>
<div onclick="openApp('paint')">Paint</div>
<div onclick="openApp('calculator')">Calculator</div>
<div onclick="openApp('lucasscape')">The LucasScape</div>
<div onclick="openApp('media-player')">Media Player</div>
<div onclick="openApp('quake')">Quake</div>
<div onclick="openApp('controlpanel')">Control Panel</div>
<div onclick="openApp('me-dos')">ME-DOS Prompt</div>
<div onclick="openApp('minesweeper')">Minesweeper</div>
<div onclick="openApp('file-manager')">File Manager</div>
<div onclick="openApp('hover!')">Hover!</div>
<div onclick="openApp('skifree')">SkiFree</div>
<div onclick="openApp('excel97')">Excel 97</div>
<div onclick="openApp('vim')">Vim</div>
<div onclick="openApp('taskmanager')">Task Manager</div>
<div onclick="openApp('sysmon')">System Monitor</div>
<div onclick="openApp('themes')">Desktop Themes</div>
<div onclick="openApp('screensavers')">Desktop Screensavers</div>
<div onclick="openApp('clock')">Clock</div>
</div>
</div>
<div onclick="openApp('help')"><div class="icon">
  <img src="https://thenerdmeme.github.io/MEOS-Icon-Viewer/64.png" width="28" height="28">Help</div>
<div onclick="openApp('run')"><div class="icon">
  <img src="https://thenerdmeme.github.io/MEOS-Icon-Viewer/54.png" width="28" height="28">Run...</div>
<div onclick="openApp('find')"><div class="icon">
  <img src="https://thenerdmeme.github.io/MEOS-Icon-Viewer/3.png" width="28" height="28">Find...</div>
<div onclick="openApp('controlpanel')"><div class="icon">
  <img src="https://thenerdmeme.github.io/MEOS-Icon-Viewer/2.png" width="28" height="28">Control Panel</div>
<div onclick="location.reload()"><div class="icon">
  <img src="https://thenerdmeme.github.io/MEOS-Icon-Viewer/52.png" width="28" height="28">Shut Down...</div>
</div>
</div>
</div>
<script>
    // Basic window controls
    function openApp(id){ const app=document.getElementById(id); if(!app) return; app.style.display='block'; bringToFront(app); }
    function closeApp(id){ const el=document.getElementById(id); if(!el) return; el.style.display='none'; }
    function toggleStartMenu(){ const menu=document.getElementById('start-menu'); menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex'; }

    // Dragging
    let zCounter = 1000;
    function bringToFront(el){ zCounter++; el.style.zIndex = zCounter; }
    const makeDraggable = (id) => {
      const el = document.getElementById(id);
      if(!el) return;
      const bar = el.querySelector('.title-bar');
      let isDragging=false, ox=0, oy=0;
      bar.addEventListener('mousedown', (e)=>{ isDragging=true; const rect=el.getBoundingClientRect(); ox=e.clientX-rect.left; oy=e.clientY-rect.top; bringToFront(el); });
      document.addEventListener('mousemove', (e)=>{ if(isDragging){ el.style.left = (e.clientX-ox)+'px'; el.style.top = (e.clientY-oy)+'px'; }});
      document.addEventListener('mouseup', ()=>{ isDragging=false; });
      el.addEventListener('mousedown', ()=>{ bringToFront(el); activeWindow = el; });
    };
    document.querySelectorAll('.window').forEach(win => {
      if (win.id) makeDraggable(win.id);
    });

    // Context menu + clipboard
    const contextMenu = document.getElementById('context-menu');
    const ctxRefresh = document.getElementById('ctx-refresh');
    const ctxCut = document.getElementById('ctx-cut');
    const ctxCopy = document.getElementById('ctx-copy');
    const ctxPaste = document.getElementById('ctx-paste');
    const ctxOpenControl = document.getElementById('ctx-open-control');

    let activeWindow = null;
    let activeEditable = null;
    document.addEventListener('mousedown', (e) => {
      if (e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        activeEditable = e.target;
        activeWindow = e.target.closest('.window') || activeWindow;
      }
    });
    activeWindow = document.getElementById('notepad');

    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const win = e.target.closest('.window');
      if (win) activeWindow = win;
      if (e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) activeEditable = e.target;
      contextMenu.style.left = e.pageX + 'px';
      contextMenu.style.top = e.pageY + 'px';
      contextMenu.style.display = 'flex';
      contextMenu.setAttribute('aria-hidden','false');
      bringToFront(contextMenu);
    });
    document.addEventListener('click', (e)=>{ if(!e.target.closest('#context-menu')) hideContextMenu(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideContextMenu(); });
    function hideContextMenu(){ contextMenu.style.display='none'; contextMenu.setAttribute('aria-hidden','true'); }

    ctxRefresh.addEventListener('click', ()=>{ hideContextMenu(); location.reload(); });
    ctxOpenControl.addEventListener('click', ()=>{ hideContextMenu(); openApp('controlpanel'); });

    async function writeToClipboard(text){ try{ await navigator.clipboard.writeText(text); return true;}catch(e){console.warn('clipboard write failed',e); return false;} }
    async function readFromClipboard(){ try{ return await navigator.clipboard.readText(); }catch(e){ console.warn('clipboard read failed',e); throw e; } }

    ctxCut.addEventListener('click', async ()=>{ hideContextMenu(); if(!activeWindow) return alert('No active window to cut from.'); const target = activeEditable && activeWindow.contains(activeEditable) ? activeEditable : activeWindow.querySelector('textarea'); if(target && target.selectionStart!==undefined){ if(target.selectionStart===target.selectionEnd){ alert('Nothing selected to cut.'); return; } const selected = target.value.substring(target.selectionStart,target.selectionEnd); const ok = await writeToClipboard(selected); if(!ok){ alert('Cut failed: permission denied'); return; } const before = target.value.substring(0,target.selectionStart); const after = target.value.substring(target.selectionEnd); target.value = before + after; target.selectionStart = target.selectionEnd = before.length; target.focus(); }else{ alert('No editable area in active window.'); } });

    ctxCopy.addEventListener('click', async ()=>{ hideContextMenu(); if(!activeWindow) return alert('No active window to copy from.'); const target = activeEditable && activeWindow.contains(activeEditable) ? activeEditable : activeWindow.querySelector('textarea'); if(target && target.selectionStart!==undefined){ if(target.selectionStart===target.selectionEnd){ alert('Nothing selected to copy.'); return; } const selected = target.value.substring(target.selectionStart,target.selectionEnd); const ok = await writeToClipboard(selected); if(!ok){ alert('Copy failed: permission denied'); return; } }else{ alert('No editable area in active window.'); } });

    ctxPaste.addEventListener('click', async ()=>{ hideContextMenu(); if(!activeWindow) return alert('No active window to paste into.'); const target = activeEditable && activeWindow.contains(activeEditable) ? activeEditable : activeWindow.querySelector('textarea'); if(target && target.selectionStart!==undefined){ try{ const text = await readFromClipboard(); const start = target.selectionStart; const end = target.selectionEnd; const before = target.value.substring(0,start); const after = target.value.substring(end); target.value = before + text + after; const newPos = start + text.length; target.selectionStart = target.selectionEnd = newPos; target.focus(); }catch(err){ alert('Paste failed: permission denied or unavailable.'); } }else{ alert('No editable area in active window.'); } });

    // Accessibility focusin handling
    document.addEventListener('focusin', (e)=>{ if(e.target.tagName==='TEXTAREA' || e.target.isContentEditable){ activeEditable = e.target; activeWindow = e.target.closest('.window') || activeWindow; if(activeWindow) bringToFront(activeWindow); } });

    /* --- Filesystem (cd + dir) & ME-DOS logic with virus commands --- */
    const fsRoot = {
      "C:": { type:"dir", children: {
        "MEOS": { type:"dir", children: {
          "README.TXT": { type:"file", content:"Welcome to MagicME MEOS\nUse cd and dir to navigate." }
        }},
        "MEOS.SYS": { type:"file", content:"System file (binary)"},
        "COMMAND.COM": { type:"file", content:"Shell binary"}
      }}
    };
    let currentPath = ["C:"];

    function getDirNode(pathArr){
      let node = fsRoot;
      for(let i=0;i<pathArr.length;i++){
        const p = pathArr[i];
        if(!node[p]) return null;
        node = node[p];
        if(node.type==="dir") node = node.children;
      }
      return { type:"dir", children: node };
    }
    function updatePrompt(){ const p = currentPath.length===1? currentPath[0]+'\\' : currentPath.join('\\')+'\\'; document.getElementById('dos-prompt').textContent = p + '>'; }
    updatePrompt();

    function cmd_dir(){
      const dn = getDirNode(currentPath);
      if(!dn) return "Directory not found.";
      const names = Object.keys(dn.children).sort();
      if(names.length===0) return " Volume in drive C has no label.\n Directory of " + currentPath.join('\\') + "\\\n\n   <empty>";
      let lines = [" Volume in drive C has no label."," Directory of " + currentPath.join('\\') + "\\",""];
      names.forEach(n=>{ const it = dn.children[n]; if(it.type==="dir") lines.push("<DIR>    " + n); else lines.push("         " + n + "    " + (it.content? it.content.length : 0) + " bytes"); });
      return lines.join("\n");
    }

    function cmd_cd(arg){
      if(!arg || arg.trim()==="") return "";
      const target = arg.trim();
      if(target===".."){ if(currentPath.length>1){ currentPath.pop(); updatePrompt(); return ""; } else return "Already at root."; }
      const parts = target.replace(/^\\+|\\+$/g,"").split("\\").filter(Boolean);
      let newPath = currentPath.slice();
      if(parts.length>0 && /^[A-Za-z]:$/.test(parts[0])){ newPath = [parts[0]]; parts.shift(); }
      for(const p of parts){
        const dn = getDirNode(newPath);
        if(!dn) return "Path not found.";
        const child = dn.children[p];
        if(!child) return "The system cannot find the path specified: " + p;
        if(child.type!=="dir") return p + " is not a directory.";
        newPath.push(p);
      }
      currentPath = newPath; updatePrompt(); return "";
    }

    // DOS UI elements
    const dosOutput = document.getElementById('dos-output');
    const dosInput = document.getElementById('dos-input');
    const dosPrompt = document.getElementById('dos-prompt');
    const dosTerminal = document.getElementById('dos-terminal');
    const asciiOverlay = document.getElementById('ascii-overlay');

    function pathToString(pa){ return pa.join('\\') + '\\'; }

    function showAsciiArt(text){ asciiOverlay.textContent = text; dosTerminal.classList.add('infected'); }
    function hideAsciiArt(){ asciiOverlay.textContent=''; dosTerminal.classList.remove('infected'); }

    function randomGlitchLine(){ const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()[]{}<>/\\|'; let len=30 + Math.floor(Math.random()*30); let s=''; for(let i=0;i<len;i++) s+=chars.charAt(Math.floor(Math.random()*chars.length)); return s; }

    function virusEffectSequence(type){
      dosTerminal.classList.add('shake'); dosTerminal.classList.add('alert');
      let count = type==='big'? 12:6;
      for(let i=0;i<count;i++){
        setTimeout(()=>{ dosOutput.textContent += "\n" + randomGlitchLine(); dosOutput.scrollTop = dosOutput.scrollHeight; }, 120*i);
      }
      if(type==='big'){
        const art = [
"  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó",
" ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù",
" ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó",
" ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë",
" ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë",
" ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù",
"",
"*** DATA CRIME DETECTED ***"
        ].join("\n");
        showAsciiArt(art);
      }
      setTimeout(()=>{ dosTerminal.classList.remove('shake'); }, 1000);
      setTimeout(()=>{ dosTerminal.classList.remove('alert'); hideAsciiArt(); }, 1400);
    }

    function runDatacrimeVisual(){
      dosTerminal.classList.add('infected');
      const art = [
" +--------------------------------------------+",
" |   ATTENTION:                                |",
" |   I have been elected to inform you that   |",
" |   throughout your process of collecting... |",
" |   *** DATA CRIME DETECTED ***               |",
" +--------------------------------------------+"
      ].join("\n");
      showAsciiArt(art);
      setTimeout(()=>{ dosTerminal.classList.remove('infected'); hideAsciiArt(); }, 1200);
    }

    dosInput.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        const raw = dosInput.value.trim();
        const parts = raw.split(' ').filter(Boolean);
        const cmd = parts[0] ? parts[0].toLowerCase() : '';
        const arg = parts.slice(1).join(' ');
        let response = '';

        if(cmd === 'help'){ response = 'Supported commands: help, dir, cd, cls, clear, ver, date, time, exit, datacrime, virus, virusall, panic, recover'; }
        else if(cmd === 'dir'){ response = cmd_dir(); }
        else if(cmd === 'cd' && arg.toLowerCase() === 'con'){
  response = "FATAL SYSTEM ERROR\nAttempting to access CON device twice!";

  // Replace body with simulated BSOD
  document.body.innerHTML = `
    <div style="
      background:black;
      color:white;
      font-family:monospace;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      width:100%;
      height:100%;
      text-align:center;
      ">
      <h1>*** MEOS SYSTEM FAILURE ***</h1>
      <p>A fatal exception 0E has occurred at 0028:C0005338 in VXD VMM(01) +</p>
      <p>00004338. The current application will be terminated.</p>
      <br>
      <p>Press any key to restart your computer.</p>
      <p>(If this is the first time you've seen this Stop error screen,<br>
      restart your computer. If this screen appears again, follow<br>
      these steps:)</p>
    </div>`;

  // Auto-restart after 5 seconds
  setTimeout(()=>{ location.reload(); }, 5000);

  return; // stop normal DOS output
}
else if(cmd === 'cd'){ response = cmd_cd(arg); }
        else if(cmd === 'cls' || cmd === 'clear'){ dosOutput.textContent = "MagicME(R) MEOS\n(C)Copyright MagicME 1995-1996, 1996-1997, 1997-2000, 2000-2001, 2025\n"; dosInput.value=''; return; }
        else if(cmd === 'ver'){ response = "MagicME(R) MEOS [Version v1.0]\n(C) MagicME 1995-1996, 1996-1997, 1997-2000, 2000-2001, 2025"; }
        else if(cmd === 'date'){ response = new Date().toLocaleDateString(); }
        else if(cmd === 'time'){ response = new Date().toLocaleTimeString(); }
        else if(cmd === 'exit'){ dosOutput.textContent += "\n" + dosPrompt.textContent + raw + "\nExiting ME-DOS...\n"; dosInput.value=''; setTimeout(()=>{ closeApp('me-dos'); },200); return; }
        else if(cmd === 'datacrime'){ response = "*** DATA CRIME DETECTED ***\nSYSTEM BREACH AT " + pathToString(currentPath) + "\nPLEASE CONTACT MAGICME SECURITY"; runDatacrimeVisual(); }
        else if(cmd === 'virus'){ response = "Launching cosmetic virus...\n(Non-destructive)"; virusEffectSequence('small'); }
        else if(cmd === 'virusall'){ response = "Launching full cosmetic infection sequence...\n(Non-destructive)"; virusEffectSequence('big'); setTimeout(()=>{ dosOutput.textContent += "\n*** ALL VIRUSES SIMULATED (cosmetic) ***\n"; dosOutput.scrollTop = dosOutput.scrollHeight; }, 1300); }
        else if(cmd === 'panic'){ response = "!!! PANIC MODE !!!\nSystem instability simulated."; dosTerminal.classList.add('alert'); setTimeout(()=>{ dosTerminal.classList.remove('alert'); }, 900); }

// --- Classic Virus Simulations ---
else if(cmd === 'stoned'){
  response = "Your PC is now Stoned! (simulated)\nLegalize it!";
  virusEffectSequence('small');
}

else if(cmd === 'jerusalem'){
  response = "Jerusalem virus simulated...\nPrograms deleted on Friday the 13th!";
  virusEffectSequence('big');
}

else if(cmd === 'whale'){
  response = "Whale virus simulated...\nBeware of the big one!";
  showAsciiArt("üêã  The WHALE has swallowed your system!");
  setTimeout(hideAsciiArt, 2000);
}

else if(cmd === 'abraxas'){
  response = "Abraxas illusion simulated...\nReality bends...";
  virusEffectSequence('big');
}

else if(cmd === 'ambulance'){
  response = "Ambulance virus simulated...\nüöë Ambulance racing across the screen!";
  let pos = 0;
  const interval = setInterval(()=>{
    asciiOverlay.innerHTML = "üöë".padStart(pos, " ");
    dosTerminal.classList.add("infected");
    pos++;
    if(pos > 40){ clearInterval(interval); hideAsciiArt(); }
  }, 100);
}

else if(cmd === 'techno'){
  response = "Techno virus simulated...\nPsychedelic glitch!";
  for(let i=0;i<6;i++){
    setTimeout(()=>{ dosOutput.textContent += "\n‚ñí‚ñì‚ñë‚ñì‚ñí‚ñë‚ñì‚ñí‚ñë‚ñì‚ñí‚ñë‚ñì‚ñí‚ñë‚ñì‚ñí‚ñë"; dosOutput.scrollTop = dosOutput.scrollHeight; }, i*200);
  }
}

else if(cmd === 'zmist'){
  response = "ZMist virus simulated...\nMetamorphic mutation underway...";
  virusEffectSequence('big');
  setTimeout(()=>{ showAsciiArt("ZMIST: Polymorphic chaos unleashed!"); }, 800);
  setTimeout(hideAsciiArt, 2000);
}

        
        else if(cmd === 'q-walker'){
          response = "Q-WALKER started...\n(press RECOVER to stop)";
          const walker = document.getElementById("walker-overlay");
          walker.style.display = "block";
          walker.style.left = "10px";

          let pos = 10;
          const walkInterval = setInterval(()=>{
            pos += 5;
            walker.style.left = pos + "px";
            if(pos > dosTerminal.offsetWidth - 100) pos = 10; // loop around
          }, 120);

          walker.dataset.walkerInterval = walkInterval;
        }
    
        else if(cmd === 'recover'){ response = "Attempting cosmetic recovery...\nTerminal restored."; dosTerminal.classList.remove('alert'); dosTerminal.classList.remove('infected'); hideAsciiArt(); }
        else if(cmd === ''){ response = ''; }
        else { response = `'${raw}' is not recognized as an internal or external command.`; }

        if(response !== '') dosOutput.textContent += "\n" + dosPrompt.textContent + raw + "\n" + response + "\n";
        else dosOutput.textContent += "\n" + dosPrompt.textContent + raw + "\n";

        dosInput.value = '';
        dosOutput.scrollTop = dosOutput.scrollHeight;
      }
    });

    
// --- Media Player Controls ---
// --- Save As (Download) ---
function saveTextFile(filename, text) {
  const blob = new Blob([text], { type: "text/plain" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  URL.revokeObjectURL(link.href);
}

// Notepad Save As
function saveNotepad() {
  const text = document.querySelector("#notepad textarea").value;
  const filename = prompt("Save As", "document.txt");
  if (filename) {
    saveTextFile(filename, text);
  }
}

// Write Save As
function saveWrite() {
  const text = document.querySelector("#write textarea").value;
  const filename = prompt("Save As", "document.rtf");
  if (filename) {
    saveTextFile(filename, text);
  }
}

const mediaFile = document.getElementById("media-file");
const mediaVideo = document.getElementById("media-element");
const mediaAudio = document.getElementById("media-audio");
const slider = document.getElementById("media-slider");

function attachMediaEvents(media) {
  media.addEventListener("timeupdate", () => {
    slider.value = (media.currentTime / media.duration) * 100 || 0;
  });
  slider.addEventListener("input", () => {
    media.currentTime = (slider.value / 100) * media.duration;
  });
}

mediaFile.addEventListener("change", () => {
  const file = mediaFile.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  if (file.type.startsWith("video")) {
    mediaAudio.style.display = "none";
    mediaVideo.style.display = "block";
    mediaVideo.src = url;
    attachMediaEvents(mediaVideo);
  } else if (file.type.startsWith("audio")) {
    mediaVideo.style.display = "none";
    mediaAudio.style.display = "block";
    mediaAudio.src = url;
    attachMediaEvents(mediaAudio);
  }
});

function playMedia() {
  if (mediaVideo.style.display === "block") mediaVideo.play();
  if (mediaAudio.style.display === "block") mediaAudio.play();
}
function pauseMedia() {
  if (mediaVideo.style.display === "block") mediaVideo.pause();
  if (mediaAudio.style.display === "block") mediaAudio.pause();
}
function stopMedia() {
  if (mediaVideo.style.display === "block") {
    mediaVideo.pause();
    mediaVideo.currentTime = 0;
  }
  if (mediaAudio.style.display === "block") {
    mediaAudio.pause();
    mediaAudio.currentTime = 0;
  }
}


// --- Calculator ---
function calcInput(val) {
  document.getElementById("calc-display").value += val;
}
function calcClear() {
  document.getElementById("calc-display").value = "";
}
function calcEquals() {
  try {
    document.getElementById("calc-display").value =
      eval(document.getElementById("calc-display").value);
  } catch {
    document.getElementById("calc-display").value = "Error";
  }
}

// --- Minesweeper ---
function startMinesweeper(rows=9, cols=9, mines=10) {
  const gridEl = document.getElementById("ms-grid");
  const counterEl = document.getElementById("ms-counter");
  const timerEl = document.getElementById("ms-timer");
  const faceEl = document.getElementById("ms-face");

  let grid = [];
  let gameOver = false;
  let flags = 0;
  let timer = 0;
  let timerInt = null;

  gridEl.innerHTML = "";
  gridEl.style.display = "inline-block";

  // Build grid
  for (let r=0;r<rows;r++) {
    const rowEl = document.createElement("div");
    rowEl.className = "ms-row";
    grid[r] = [];
    for (let c=0;c<cols;c++) {
      const cell = document.createElement("div");
      cell.className = "ms-cell";
      cell.dataset.r = r;
      cell.dataset.c = c;
      rowEl.appendChild(cell);
      grid[r][c] = {el:cell, mine:false, num:0, revealed:false, flag:false};
    }
    gridEl.appendChild(rowEl);
  }

  // Place mines
  let placed = 0;
  while (placed < mines) {
    let r = Math.floor(Math.random()*rows);
    let c = Math.floor(Math.random()*cols);
    if (!grid[r][c].mine) {
      grid[r][c].mine = true;
      placed++;
    }
  }

  // Calculate numbers
  for (let r=0;r<rows;r++) {
    for (let c=0;c<cols;c++) {
      if (grid[r][c].mine) continue;
      let count = 0;
      for (let dr=-1;dr<=1;dr++) {
        for (let dc=-1;dc<=1;dc++) {
          if (grid[r+dr] && grid[r+dr][c+dc] && grid[r+dr][c+dc].mine) count++;
        }
      }
      grid[r][c].num = count;
    }
  }

  const colors = {1:"blue",2:"green",3:"red",4:"navy",5:"brown",6:"teal",7:"black",8:"gray"};

  function reveal(r,c) {
    const cell = grid[r][c];
    if (!cell || cell.revealed || cell.flag) return;
    cell.revealed = true;
    cell.el.classList.add("revealed");
    if (cell.mine) {
      cell.el.textContent = "üí£";
      cell.el.classList.add("mine");
      gameOver = true;
      faceEl.textContent = "üòµ";
      clearInterval(timerInt);
      return;
    }
    if (cell.num > 0) {
      cell.el.textContent = cell.num;
      cell.el.style.color = colors[cell.num];
    } else {
      for (let dr=-1;dr<=1;dr++) {
        for (let dc=-1;dc<=1;dc++) {
          if (grid[r+dr] && grid[r+dr][c+dc]) reveal(r+dr,c+dc);
        }
      }
    }
  }

  function toggleFlag(r,c) {
    const cell = grid[r][c];
    if (!cell || cell.revealed) return;
    cell.flag = !cell.flag;
    cell.el.textContent = cell.flag ? "üö©" : "";
    cell.el.classList.toggle("flag", cell.flag);
    flags += cell.flag ? 1 : -1;
    counterEl.textContent = String(mines-flags).padStart(3,"0");
  }

  grid.forEach(row=>row.forEach(cell=>{
    cell.el.onmousedown = (e)=>{
      if (gameOver) return;
      if (!timerInt) {
        timerInt = setInterval(()=>{
          timer++;
          timerEl.textContent = String(timer).padStart(3,"0");
        },1000);
      }
      const r = +cell.el.dataset.r;
      const c = +cell.el.dataset.c;
      if (e.button===0) reveal(r,c);
      if (e.button===2) toggleFlag(r,c);
    };
    cell.el.oncontextmenu = (e)=>e.preventDefault();
  }));

  faceEl.onclick = ()=>startMinesweeper(rows,cols,mines);

  counterEl.textContent = String(mines).padStart(3,"0");
  timerEl.textContent = "000";
  faceEl.textContent = "üôÇ";
  timer = 0;
  clearInterval(timerInt);
  timerInt = null;
}

document.addEventListener("DOMContentLoaded", ()=>startMinesweeper(9,9,10));

// End of script
// === MEF Support ===
let mefViewerFilename = "document.mef";

function openMefFileFromPath(name, content) {
  const mefFrame = document.getElementById("mef-frame");
  const mefEditor = document.getElementById("mef-editor");

  mefEditor.style.display = "none";
  mefFrame.style.display = "block";

  const blob = new Blob([content], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  mefFrame.src = url;

  mefEditor.value = content;
  mefViewerFilename = name;

  openApp("mef-viewer");
}

function downloadMef() {
  const mefFrame = document.getElementById("mef-frame");
  const mefEditor = document.getElementById("mef-editor");

  let content = "";
  if (mefEditor.style.display === "block") {
    content = mefEditor.value;
  } else {
    try {
      content = mefFrame.contentDocument.documentElement.outerHTML;
    } catch {
      content = mefEditor.value;
    }
  }
  saveAsMef(mefViewerFilename, content);
}

function editMef() {
  const mefFrame = document.getElementById("mef-frame");
  const mefEditor = document.getElementById("mef-editor");
  mefFrame.style.display = "none";
  mefEditor.style.display = "block";
}

function viewMef() {
  const mefFrame = document.getElementById("mef-frame");
  const mefEditor = document.getElementById("mef-editor");

  const blob = new Blob([mefEditor.value], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  mefFrame.src = url;

  mefFrame.style.display = "block";
  mefEditor.style.display = "none";
}

function saveAsMef(filename, htmlContent) {
  if (!filename.toLowerCase().endsWith(".mef")) filename += ".mef";
  const blob = new Blob([htmlContent], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function saveNotepadAsMef() {
  const notepadWin = document.getElementById("notepad");
  const textarea = notepadWin.querySelector("textarea");
  let content = textarea.value;
  if (!content.trim().startsWith("<!DOCTYPE")) {
    content = "<!DOCTYPE html>\n<html><head><meta charset='utf-8'><title>MEF Document</title></head><body>\n"
              + content + "\n</body></html>";
  }
  let filename = prompt("Enter filename:", "document.mef");
  if (!filename) return;
  if (!filename.toLowerCase().endsWith(".mef")) filename += ".mef";
  saveAsMef(filename, content);
}

function saveAndOpenMef() {
  const notepadWin = document.getElementById("notepad");
  const textarea = notepadWin.querySelector("textarea");
  let content = textarea.value;
  if (!content.trim().startsWith("<!DOCTYPE")) {
    content = "<!DOCTYPE html>\n<html><head><meta charset='utf-8'><title>MEF Document</title></head><body>\n"
              + content + "\n</body></html>";
  }
  let filename = prompt("Enter filename for MEF Viewer:", "temp.mef");
  if (!filename) return;
  if (!filename.toLowerCase().endsWith(".mef")) filename += ".mef";
  openMefFileFromPath(filename, content);
}

  
function minimizeApp(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = "none"; // simple hide
}

function maximizeApp(id) {
  const el = document.getElementById(id);
  if (!el) return;
  if (el.classList.contains("maximized")) {
    el.style.top = el.dataset.top;
    el.style.left = el.dataset.left;
    el.style.width = el.dataset.width;
    el.style.height = el.dataset.height;
    el.classList.remove("maximized");
  } else {
    el.dataset.top = el.style.top;
    el.dataset.left = el.style.left;
    el.dataset.width = el.style.width;
    el.dataset.height = el.style.height;
    el.style.top = "0";
    el.style.left = "0";
    el.style.width = "100%";
    el.style.height = "calc(100% - 30px)"; // leave space for taskbar
    el.classList.add("maximized");
  }
}

const ctxOpenTask = document.getElementById('ctx-open-task');
if (ctxOpenTask) {
  ctxOpenTask.addEventListener('click', ()=>{ 
    hideContextMenu(); 
    openApp('taskmanager'); 
    refreshTaskList(); 
  });
}

function refreshTaskList() {
  const list = document.getElementById('task-list');
  if (!list) return;
  list.innerHTML = '';
  document.querySelectorAll('.window').forEach(win => {
    if (win.id !== 'taskmanager' && win.style.display !== 'none') {
      const li = document.createElement('li');
      li.textContent = win.querySelector('.title-bar span').textContent || win.id;
      list.appendChild(li);
    }
  });
}

function showTab(tab) {
  document.querySelectorAll('.task-tab').forEach(el => el.style.display = 'none');
  const tabEl = document.getElementById('tab-' + tab);
  if (tabEl) tabEl.style.display = 'block';

  if (tab === 'processes') refreshTaskList();
  if (tab === 'tasks') refreshTaskListTasks();
  if (tab === 'performance') {
    const usage = Math.floor(Math.random() * 100);
    document.getElementById('cpu-usage').textContent = usage + "%";
    document.getElementById('mem-usage').textContent = "Normal";
  }
}

function refreshTaskListTasks() {
  const list = document.getElementById('task-tasks');
  if (!list) return;
  list.innerHTML = '';
  document.querySelectorAll('.window').forEach(win => {
    if (win.id !== 'taskmanager' && win.style.display !== 'none') {
      const li = document.createElement('li');
      li.textContent = win.querySelector('.title-bar span').textContent || win.id;
      li.dataset.id = win.id;
      list.appendChild(li);
    }
  });
}

let selectedTask = null;

document.addEventListener('click', e => {
  if (e.target.closest('#task-list li, #task-tasks li')) {
    document.querySelectorAll('#task-list li, #task-tasks li').forEach(li => li.classList.remove('selected'));
    e.target.classList.add('selected');
    selectedTask = e.target.dataset.id;
  }
});

function endSelectedTask(listId) {
  const selected = document.querySelector(`#${listId} li.selected`);
  if (!selected) return alert('No task selected.');
  closeApp(selected.dataset.id);
  refreshTaskList();
  refreshTaskListTasks();
}

function switchSelectedTask(listId) {
  const selected = document.querySelector(`#${listId} li.selected`);
  if (!selected) return alert('No task selected.');
  const el = document.getElementById(selected.dataset.id);
  if (el) bringToFront(el);
}


// Theme + Screensaver system

const PRESET_THEMES = {
  "Arizona": {"menuBg":"#b97a57","menuText":"#fff","windowBg":"#ffeedd","windowBorder":"#8b4513","bg":""},
  "Black Leather Jacket": {"menuBg":"#000","menuText":"#fff","windowBg":"#222","windowBorder":"#444","bg":""},
  "Blue and Red": {"menuBg":"#0000ff","menuText":"#ff0000","windowBg":"#fff","windowBorder":"#000","bg":""},
  "Hot Dog Stand": {"menuBg":"#ff0000","menuText":"#ffff00","windowBg":"#fff","windowBorder":"#000","bg":""},
  "Ocean": {"menuBg":"#0e6ba8","menuText":"#fff","windowBg":"#e6f7ff","windowBorder":"#004d66","bg":""},
  "Pastel": {"menuBg":"#ffdfe6","menuText":"#000","windowBg":"#fff8f9","windowBorder":"#e0b7c2","bg":""},
  "The Blues": {"menuBg":"#001f4d","menuText":"#87ceeb","windowBg":"#e6f0ff","windowBorder":"#003366","bg":""},
  "Tweed": {"menuBg":"#d2b48c","menuText":"#000","windowBg":"#f5f5dc","windowBorder":"#8b7d6b","bg":""},
  "Windows Default": {"menuBg":"#c0c0c0","menuText":"#000","windowBg":"#fff","windowBorder":"#000","bg":""},
  "Dangerous Creatures": {"menuBg":"#006400","menuText":"#adff2f","windowBg":"#000","windowBorder":"#32cd32","bg":""},
  "Inside Your Computer": {"menuBg":"#333","menuText":"#0f0","windowBg":"#111","windowBorder":"#0f0","bg":""},
  "Leonardo da Vinci": {"menuBg":"#deb887","menuText":"#000","windowBg":"#fffaf0","windowBorder":"#8b4513","bg":""},
  "Mystery": {"menuBg":"#4b0082","menuText":"#dda0dd","windowBg":"#fff0ff","windowBorder":"#800080","bg":""},
  "Nature": {"menuBg":"#228b22","menuText":"#fff","windowBg":"#eaffea","windowBorder":"#006400","bg":""},
  "Science": {"menuBg":"#4682b4","menuText":"#fff","windowBg":"#f0f8ff","windowBorder":"#00008b","bg":""},
  "Space": {"menuBg":"#000","menuText":"#fff","windowBg":"#111","windowBorder":"#444","bg":""},
  "Sports": {"menuBg":"#ff8c00","menuText":"#000","windowBg":"#fffaf0","windowBorder":"#b22222","bg":""},
  "The 60's USA": {"menuBg":"#ff69b4","menuText":"#0000ff","windowBg":"#fff","windowBorder":"#ff1493","bg":""},
  "The Golden Era": {"menuBg":"#daa520","menuText":"#000","windowBg":"#fffacd","windowBorder":"#b8860b","bg":""},
  "Travel": {"menuBg":"#20b2aa","menuText":"#fff","windowBg":"#e0ffff","windowBorder":"#008b8b","bg":""},
  "Windows 95": {"menuBg":"#c0c0c0","menuText":"#000","windowBg":"#fff","windowBorder":"#000","bg":""},
  "More Windows": {"menuBg":"#808080","menuText":"#fff","windowBg":"#f5f5f5","windowBorder":"#000","bg":""}
};


function showThemeTab(tab) {
  document.querySelectorAll('.theme-tab').forEach(el=>el.style.display='none');
  const el = document.getElementById('tab-' + tab);
  if (el) el.style.display='block';
  if (tab === 'saved') refreshSavedThemesList();
}

function applyThemeFromList(){
  const sel = document.getElementById('theme-list');
  const name = sel.value;
  if (PRESET_THEMES[name]) applyThemeObject(PRESET_THEMES[name]);
}


function applyThemeObject(obj){
  document.documentElement.style.setProperty('--menu-bg', obj.menuBg || '#c0c0c0');
  document.documentElement.style.setProperty('--menu-text', obj.menuText || '#000');
  document.documentElement.style.setProperty('--window-bg', obj.windowBg || '#fff');
  document.documentElement.style.setProperty('--window-border', obj.windowBorder || '#000');
  if (obj.bg) {
    document.body.style.backgroundImage = 'url(' + obj.bg + ')';
  } else {
    document.body.style.backgroundImage = '';
    document.body.style.backgroundColor = obj.windowBg || '#ffffff';
  }
}


function applyBackground(){
  const file = document.getElementById('bg-upload').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e)=> { document.body.style.backgroundImage = 'url("' + e.target.result + '")'; };
    reader.readAsDataURL(file);
  } else {
    const c = document.getElementById('bg-color').value;
    document.body.style.background = c;
    document.body.style.backgroundImage = '';
  }
}

function clearBackground(){ document.body.style.background = ''; document.body.style.backgroundImage = ''; }

function applyColors(){
  const mb = document.getElementById('menu-color').value;
  const mt = document.getElementById('text-color').value;
  document.documentElement.style.setProperty('--menu-bg', mb);
  document.documentElement.style.setProperty('--menu-text', mt);
}

function saveCurrentTheme(){
  const obj = {
    name: prompt('Name for this theme','Custom Theme'),
    menuBg: getComputedStyle(document.documentElement).getPropertyValue('--menu-bg') || '#c0c0c0',
    menuText: getComputedStyle(document.documentElement).getPropertyValue('--menu-text') || '#000',
    windowBg: getComputedStyle(document.documentElement).getPropertyValue('--window-bg') || '#fff',
    windowBorder: getComputedStyle(document.documentElement).getPropertyValue('--window-border') || '#000',
    bg: document.body.style.backgroundImage || ''
  };
  if (!obj.name) return;
  let saved = JSON.parse(localStorage.getItem('MEOS_THEMES')||'[]');
  saved.push(obj);
  localStorage.setItem('MEOS_THEMES', JSON.stringify(saved));
  refreshSavedThemesList();
}

function refreshSavedThemesList(){
  const list = document.getElementById('saved-themes-list');
  list.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('MEOS_THEMES')||'[]');
  saved.forEach((t,i)=>{
    const li = document.createElement('li');
    li.textContent = t.name || ('Custom ' + i);
    li.dataset.idx = i;
    li.addEventListener('click', ()=>{
      document.querySelectorAll('#saved-themes-list li').forEach(x=>x.classList.remove('selected'));
      li.classList.add('selected');
    });
    list.appendChild(li);
  });
}

function exportSelectedTheme(){
  const sel = document.querySelector('#saved-themes-list li.selected');
  if (!sel) return;
  const idx = parseInt(sel.dataset.idx,10);
  const saved = JSON.parse(localStorage.getItem('MEOS_THEMES')||'[]');
  const blob = new Blob([JSON.stringify(saved[idx])], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = (saved[idx].name||'theme') + '.met';
  a.click();
  URL.revokeObjectURL(url);
}

function importTheme(){
  const f = document.getElementById('import-theme').files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const obj = JSON.parse(e.target.result);
      let saved = JSON.parse(localStorage.getItem('MEOS_THEMES')||'[]');
      saved.push(obj);
      localStorage.setItem('MEOS_THEMES', JSON.stringify(saved));
      refreshSavedThemesList();
    }catch(err){}
  };
  reader.readAsText(f);
}

function deleteSelectedSavedTheme(){
  const sel = document.querySelector('#saved-themes-list li.selected');
  if (!sel) return;
  const idx = parseInt(sel.dataset.idx,10);
  let saved = JSON.parse(localStorage.getItem('MEOS_THEMES')||'[]');
  saved.splice(idx,1);
  localStorage.setItem('MEOS_THEMES', JSON.stringify(saved));
  refreshSavedThemesList();
}

// Screensavers
function applyScreensaver(){
  const file = document.getElementById('ss-upload').files[0];
  const list = document.getElementById('screensaver-list');
  const selected = list.value;
  if (file) {
    const reader = new FileReader();
    reader.onload = (e)=>{
      document.getElementById('screensaver-preview').innerHTML = '<img src="'+e.target.result+'" style="max-width:100%; max-height:100%;">';
      document.body.style.backgroundImage = 'url("'+e.target.result+'")';
    };
    reader.readAsDataURL(file);
  } else if (selected) {
    const presets = {
      "Matrix Rain":"https://media.giphy.com/media/3o7aD2saalBwwftBIY/giphy.gif",
      "Floating Bubbles":"https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif",
      "Starfield":"https://media.giphy.com/media/3o6Zt6ML6BklcajjsA/giphy.gif",
      "Slideshow":"https://media.giphy.com/media/xT0Gqc7kXcG8u2wQpK/giphy.gif"
    };
    const url = presets[selected];
    if (url) {
      document.getElementById('screensaver-preview').innerHTML = '<img src="'+url+'" style="max-width:100%; max-height:100%;">';
      document.body.style.backgroundImage = 'url("'+url+'")';
    }
  }
}

function clearScreensaver(){
  document.getElementById('screensaver-preview').innerHTML = '';
  document.body.style.backgroundImage = '';
}


// --- System Monitor ---
let sysmonHistory = [];
function updateSystemMonitor(){
  const cpu = Math.floor(Math.random()*100);
  const memUsed = Math.floor(Math.random()*4096);
  const procCount = document.querySelectorAll('.window').length;
  document.getElementById('sysmon-cpu').textContent = cpu + '%';
  document.getElementById('sysmon-mem').textContent = memUsed + ' MB / 4096 MB';
  document.getElementById('sysmon-proc').textContent = procCount;
  const tmCpu = document.getElementById('tm-sysmon-cpu');
  const tmMem = document.getElementById('tm-sysmon-mem');
  if (tmCpu) tmCpu.textContent = cpu + '%';
  if (tmMem) tmMem.textContent = memUsed + ' MB / 4096 MB';
  // chart
  const canvas = document.getElementById('sysmon-chart');
  if (canvas){
    const ctx = canvas.getContext('2d');
    sysmonHistory.push(cpu);
    if(sysmonHistory.length>50) sysmonHistory.shift();
    ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='#0f0'; ctx.beginPath();
    sysmonHistory.forEach((v,i)=>{
      const x = i*(canvas.width/50);
      const y = canvas.height - (v/100)*canvas.height;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
}
setInterval(updateSystemMonitor,2000);

function showCpTab(tab) {
  document.querySelectorAll('.cp-tab').forEach(el => el.style.display = 'none');
  const active = document.getElementById('cp-' + tab);
  if (active) active.style.display = 'block';
}


let clockMode = "analog"; // or "digital"

function toggleClockMode() {
  clockMode = (clockMode === "analog" ? "digital" : "analog");
  document.getElementById("clock-analog").style.display = clockMode === "analog" ? "block" : "none";
  document.getElementById("clock-digital").style.display = clockMode === "digital" ? "block" : "none";
}

function drawAnalogClock() {
  const canvas = document.getElementById("clock-analog");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const radius = canvas.width / 2;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(radius, radius);

  const now = new Date();
  const sec = now.getSeconds();
  const min = now.getMinutes();
  const hr = now.getHours();

  // Clock face
  ctx.beginPath();
  ctx.arc(0, 0, radius-5, 0, 2 * Math.PI);
  ctx.fillStyle = "#fff";
  ctx.fill();
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;
  ctx.stroke();

  // Hour hand
  let hour = hr % 12;
  hour = (hour * Math.PI / 6) + (min * Math.PI / (6*60)) + (sec * Math.PI / (360*60));
  ctx.rotate(hour);
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(0,-radius*0.5);
  ctx.stroke();
  ctx.rotate(-hour);

  // Minute hand
  let minute = (min * Math.PI / 30) + (sec * Math.PI / (30*60));
  ctx.rotate(minute);
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(0,-radius*0.8);
  ctx.stroke();
  ctx.rotate(-minute);

  // Second hand
  let second = sec * Math.PI / 30;
  ctx.strokeStyle = "red";
  ctx.rotate(second);
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(0,-radius*0.9);
  ctx.stroke();
  ctx.rotate(-second);

  ctx.restore();
}

function updateClockWin31() {
  if (clockMode === "digital") {
    const el = document.getElementById("clock-digital");
    if (el) el.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
  } else {
    drawAnalogClock();
  }
}
setInterval(updateClockWin31, 1000);




// --- Enhanced Fixes ---

// Mouse settings
function applyMouseSettings(){
  const speed = document.querySelector("#cp-mouse input[type=range]").value || 1;
  document.body.style.cursor = "url('arrow.png'), auto";
  alert("Mouse settings applied with custom cursor and speed factor " + speed);
}

// Wallpaper integration (Control Panel Desktop tab)
function applyDesktopSettings(){
  const file = document.querySelector("#cp-desktop input[type=file]").files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = (e)=>{ document.body.style.backgroundImage = 'url("'+e.target.result+'")'; };
    reader.readAsDataURL(file);
  }
  alert("Desktop wallpaper updated!");
}

// Screensaver idle activation
let idleTimer;
function resetIdleTimer(){
  clearTimeout(idleTimer);
  idleTimer = setTimeout(startScreensaver, 60000); // 1 minute idle
}
function startScreensaver(){
  const overlay = document.createElement("div");
  overlay.id = "screensaver-overlay";
  overlay.style.position = "fixed";
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = "100%";
  overlay.style.height = "100%";
  overlay.style.background = "black url('https://media.giphy.com/media/3o7aD2saalBwwftBIY/giphy.gif') center/cover";
  overlay.style.zIndex = 9999;
  document.body.appendChild(overlay);
  overlay.addEventListener("mousemove", stopScreensaver);
  overlay.addEventListener("keydown", stopScreensaver);
}
function stopScreensaver(){
  const overlay = document.getElementById("screensaver-overlay");
  if(overlay) overlay.remove();
  resetIdleTimer();
}
["mousemove","keydown","mousedown"].forEach(evt=>document.addEventListener(evt, resetIdleTimer));
resetIdleTimer();

// System & Sound
let systemSound = null;
function applySystemSound(){
  const file = document.querySelector("#cp-system input[type=file]").files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      systemSound = new Audio(e.target.result);
      alert("Custom sound loaded!");
    };
    reader.readAsDataURL(file);
  }
}
function playSystemSound(){
  if(systemSound) systemSound.play();
}

// International settings
let intlSettings = { lang:"English (US)", country:"United States", currency:"$" };
function applyInternational(){
  intlSettings.lang = document.querySelector("#cp-intl input[type=text]").value;
  intlSettings.country = document.querySelector("#cp-intl input[type=text]:nth-of-type(2)").value;
  intlSettings.currency = document.querySelector("#cp-intl input[type=text]:nth-of-type(3)").value;
  alert("International settings applied: " + JSON.stringify(intlSettings));
}

// Date/Time manual override
let manualDateTime = null;
function setManualDateTime(){
  const now = new Date();
  manualDateTime = now;
  alert("Date/Time manually set to " + now.toString());
}



// --- Fonts Fix ---
function applyFonts(){
  const font = document.querySelector("#cp-fonts select").value;
  document.body.style.fontFamily = font + ", sans-serif";
  alert("Font applied: " + font);
}

// Ensure draggability
document.querySelectorAll('.window').forEach(win => { if (win.id) makeDraggable(win.id); });

function updateControlPanelDateTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
  const dateStr = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  const timeEl = document.getElementById("cp-datetime-display");
  const dateEl = document.getElementById("cp-datetime-date");
  if (timeEl) timeEl.textContent = timeStr;
  if (dateEl) dateEl.textContent = dateStr;
}
setInterval(updateControlPanelDateTime, 1000);
updateControlPanelDateTime();


function applyColorScheme() {
  const scheme = document.getElementById("color-scheme").value;
  if (scheme === "Default") {
    applyThemeObject(PRESET_THEMES["Windows Default"]);
  } else if (scheme === "High Contrast") {
    applyThemeObject(PRESET_THEMES["Black Leather Jacket"]);
  } else if (scheme === "Ocean") {
    applyThemeObject(PRESET_THEMES["Ocean"]);
  }
  alert(scheme + " scheme applied!");
}

let scheduledTasks = [];

function addTask() {
  const time = document.getElementById("task-time").value;
  const desc = document.getElementById("task-desc").value.trim();
  if (!time || !desc) {
    alert("Please enter both time and description.");
    return;
  }
  scheduledTasks.push({ time, desc });
  renderTasks();
  document.getElementById("task-time").value = "";
  document.getElementById("task-desc").value = "";
}

function renderTasks() {
  const ul = document.getElementById("task-list-datetime");
  ul.innerHTML = "";
  scheduledTasks.forEach((t, i) => {
    const li = document.createElement("li");
    li.textContent = t.time + " - " + t.desc;
    ul.appendChild(li);
  });
}

setInterval(() => {
  const now = new Date();
  const current = now.toTimeString().slice(0,5);
  scheduledTasks.forEach(t => {
    if (t.time === current) {
      alert("Task Reminder: " + t.desc);
    }
  });
}, 60000);


// Startup sequence
window.addEventListener("load", () => {
  const startup = document.getElementById("startup-screen");
  if (startup) {
    setTimeout(() => {
      startup.style.opacity = "0";
      startup.style.transition = "opacity 1s ease";
      setTimeout(() => { startup.remove(); }, 1000);
    }, 3500); // 3.5s startup duration
  }
});

// --- Run (Autocomplete + Execution) ---
function getAllApps() {
  const apps = {};
  document.querySelectorAll(".window").forEach(win => {
    const id = win.id.toLowerCase();
    const title = win.querySelector(".title-bar span")?.textContent.toLowerCase();
    if (id) apps[id] = win.id;
    if (title) apps[title] = win.id;
  });
  return apps;
}

function updateRunSuggestions() {
  const input = document.getElementById("run-input").value.toLowerCase();
  const list = document.getElementById("run-suggestions");
  list.innerHTML = "";
  if (!input) {
    list.style.display = "none";
    return;
  }
  const apps = getAllApps();
  const matches = Object.keys(apps).filter(key => key.includes(input));
  if (matches.length === 0) {
    list.style.display = "none";
    return;
  }
  matches.forEach(match => {
    const li = document.createElement("li");
    li.textContent = match;
    li.style.padding = "2px 6px";
    li.style.cursor = "pointer";
    li.onmouseenter = () => (li.style.background = "#c0c0c0");
    li.onmouseleave = () => (li.style.background = "");
    li.onclick = () => {
      document.getElementById("run-input").value = match;
      list.style.display = "none";
    };
    list.appendChild(li);
  });
  list.style.display = "block";
}

function executeRun() {
  const cmd = document.getElementById("run-input").value.trim().toLowerCase();
  const apps = getAllApps();
  if (apps[cmd]) {
    openApp(apps[cmd]);
    closeApp("run");
  } else {
    alert("'" + cmd + "' is not recognized as an installed application.");
  }
}

// --- Find (Search Filesystem) ---
function executeFind() {
  const term = document.getElementById("find-input").value.trim().toLowerCase();
  const resultsEl = document.getElementById("find-results");
  resultsEl.innerHTML = "";
  if (!term) return;
  let results = [];
  function searchNode(node, path) {
    for (const name in node) {
      const item = node[name];
      if (name.toLowerCase().includes(term)) {
        results.push(path + "\\" + name);
      }
      if (item.type === "dir") {
        searchNode(item.children, path + "\\" + name);
      }
    }
  }
  searchNode(fsRoot["C:"].children, "C:");
  if (results.length === 0) {
    resultsEl.innerHTML = "<li>No results found.</li>";
  } else {
    results.forEach(r => {
      const li = document.createElement("li");
      li.textContent = r;
      resultsEl.appendChild(li);
    });
  }
}


let currentCursorURL = null;

function applyCustomCursor() {
  const fileInput = document.getElementById("cursor-upload");
  const file = fileInput.files[0];
  if (!file) {
    alert("Please select a .png or .ico file.");
    return;
  }
  currentCursorURL = URL.createObjectURL(file);

  document.body.style.cursor = `url(${currentCursorURL}), auto`;
  document.querySelectorAll("body, .window, .start-button, .win95-btn, .menu-bar, .submenu, .icon, .ms-cell")
    .forEach(el => el.style.cursor = `url(${currentCursorURL}), auto`);
}

function resetCursor() {
  currentCursorURL = null;
  document.body.style.cursor = `url('arrow.png') 0 0, auto`;
  document.querySelectorAll("body, .window, .start-button, .win95-btn, .menu-bar, .submenu, .icon, .ms-cell")
    .forEach(el => el.style.cursor = `url('arrow.png') 0 0, auto`);
}


// --- MEF Viewer helpers: Upload, Edit, View, Download, and Help ---
(function(){
  function getEl(id){ return document.getElementById(id); }
  const mefFrame = getEl('mef-frame');
  const mefEditor = getEl('mef-editor');
  const mefUpload = getEl('mef-upload');

  // Load text into iframe (using srcdoc when available)
  function loadMefContent(text){
    try{
      if('srcdoc' in mefFrame){
        mefFrame.srcdoc = text;
      } else {
        const blob = new Blob([text], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        mefFrame.src = url;
        // revoke after a short delay
        setTimeout(()=> URL.revokeObjectURL(url), 2000);
      }
    }catch(e){
      console.warn('loadMefContent error', e);
      mefFrame.src = 'about:blank';
    }
  }

  window.downloadMef = function(){
    // If editor visible, use its contents; otherwise try to fetch iframe content if available.
    let content = mefEditor && mefEditor.style.display !== 'none' ? mefEditor.value : null;
    if(!content){
      try{
        // try to grab iframe document body text (may be cross-origin)
        const doc = mefFrame.contentDocument || mefFrame.contentWindow && mefFrame.contentWindow.document;
        if(doc) content = doc.documentElement && doc.documentElement.outerHTML || doc.body && doc.body.innerText || '';
      }catch(e){
        content = '';
      }
    }
    if(!content) content = prompt('No content detected in MEF viewer. Enter filename to save a blank MEF:', '<empty>');
    const filename = prompt('Save MEF as', 'file.mef');
    if(filename){
      const blob = new Blob([content || ''], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }
  };

  window.editMef = function(){
    if(!mefEditor) return alert('MEF editor not available.');
    // If iframe has content, try to populate editor with it
    try{
      const doc = mefFrame.contentDocument || mefFrame.contentWindow && mefFrame.contentWindow.document;
      if(doc){
        mefEditor.value = doc.documentElement ? doc.documentElement.outerHTML : (doc.body && doc.body.innerText) || mefEditor.value;
      }
    }catch(e){
      // ignore cross-origin
    }
    mefEditor.style.display = 'block';
    mefFrame.style.display = 'none';
    mefEditor.focus();
  };

  window.viewMef = function(){
    if(!mefEditor) return;
    const text = mefEditor.value || '';
    mefEditor.style.display = 'none';
    mefFrame.style.display = 'block';
    loadMefContent(text);
  };

  // Upload handler
  mefUpload.addEventListener('change', function(e){
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      const text = ev.target.result;
      // put into editor and iframe
      if(mefEditor){ mefEditor.value = text; mefEditor.style.display = 'block'; }
      if(mefFrame){ loadMefContent(text); mefFrame.style.display = 'block'; }
      openApp('mef-viewer');
    };
    // read as text for typical MEF; if binary, fallback to ArrayBuffer then to blob url
    reader.readAsText(f);
  });

  // Optional global function to programmatically open help for MEF viewer
  window.mefHelp = function(){
    openApp('help');
    // Optionally, scroll help to MEF-related section if exists
  };

})();
</script>
</div></body>
</html>
